(function(){tinymce.PluginManager.requireLangPack("kronos.kronos");tinymce.create("tinymce.plugins.Kronos",{init:function(c,d){var e=this;e.editor=c;e.theme_enabled=tinyMCE.activeEditor.getParam("kronos_theme_enabled");e.default_theme=tinyMCE.activeEditor.getParam("kronos_default_theme");if(e.theme_enabled){c.kronos_theme_def={};c.kronos_theme_def[0]={label:c.getLang("kronos.default_theme"),css_text:"body{} p{margin:0px; padding:0px;}"};var b=tinyMCE.activeEditor.getParam("kronos_theme_list");if(b){for(var a in b){c.kronos_theme_def[a]=b[a]}}c.onBeforeSetContent.add(e._setContent,e);c.onPostProcess.add(e._postProcess,e);c.onGetContent.add(e._getContent,e);c.onInit.add(e._setDefaultTheme,e)}c.addCommand("mceKronosMergeField",function(){c.windowManager.open({file:d+"/mergefield.html",width:300+c.getLang("example.delta_width",0),height:100+c.getLang("example.delta_height",0),inline:1},{plugin_url:d,some_custom_arg:"custom arg"})});c.addCommand("mceKronosTypeTextPlaceholder",function(){c.execCommand("mceInsertContent",false,"&lt;!-- "+c.getLang("kronos.placeholder_text")+"  --&gt;")});c.addCommand("mceSelectTheme",function(g,f){e._selectTheme(f)});c.addCommand("mceKronosMergePreview",function(){Mail.ShowMergePreview(c.getContent())});c.addButton("kronos_mergefield",{title:"kronos.mergefield_desc",cmd:"mceKronosMergeField",image:"img/icons/mergefield.png"});c.addButton("kronos_mergepreview",{title:"kronos.mergepreview_desc",cmd:"mceKronosMergePreview",image:"media/default/icons/merge_preview.png"});c.addButton("kronos_type_text_placeholder",{title:"kronos.typetextplaceholder_desc",cmd:"mceKronosTypeTextPlaceholder",image:"media/default/icons/insert_type_text.png"});c.onInit.add(function(){c.dom.loadCSS(d+"/css/content.css");if(c.theme.onResolveName){c.theme.onResolveName.add(function(f,g){if(g.node.nodeName=="SPAN"&&c.dom.hasClass(g.node,"mceKronosMergeField")){g.name="kronos_mergefield"}})}});c.onNodeChange.add(function(g,f,h){if(h.nodeName==="SPAN"&&g.dom.hasClass(h,"mceKronosMergeField")){f.setActive("kronos_mergefield",true)}else{f.setActive("kronos_mergefield",false)}});c.onClick.add(function(f,g){g=g.target;if(g.nodeName==="SPAN"&&f.dom.hasClass(g,"mceKronosMergeField")){f.selection.select(g)}});c.onKeyDown.add(function(m,o){var k=m.selection.getNode();var q=false;var h=false;if(!IE){var f=m.selection.getRng();var g=f.startContainer;if(g&&(g.nodeType!=3||(g.nodeType==3&&f.startOffset==0))){var j=g;while(j!=null&&j.previousSibling==null){j=j.parentNode}if(j!=null){q=j.previousSibling}}var l=f.startContainer;if(l&&(l.nodeType!=3||(l.nodeType==3&&f.endOffset==g.nodeValue.length))){var j=l;while(j!=null&&j.nextSibling==null){j=j.parentNode}if(j!=null){h=j.nextSibling}}}var s=(k.nodeName==="SPAN"&&m.dom.hasClass(k,"mceKronosMergeField"));if(!IE){var r=(q&&q.nodeName==="SPAN"&&m.dom.hasClass(q,"mceKronosMergeField"));var p=(h&&h.nodeName==="SPAN"&&m.dom.hasClass(h,"mceKronosMergeField"))}switch(o.keyCode){case 8:if(IE&&s){k.parentNode.removeChild(k)}else{if(s&&q==false){k.parentNode.removeChild(k)}else{if(r){q.parentNode.removeChild(q)}}}break;case 46:if(IE&&s){k.parentNode.removeChild(k)}else{if(s&&h==false){k.parentNode.removeChild(k)}else{if(p){h.parentNode.removeChild(h)}}}break}});c.onKeyPress.add(function(h,k){var j=h.selection.getNode();if(j.nodeName==="SPAN"&&h.dom.hasClass(j,"mceKronosMergeField")){switch(k.keyCode){case 8:case 46:case 37:case 38:case 39:case 40:return true}if(!IE){var g=h.selection.getRng();var m=g.startContainer;if(m&&(m.nodeType!=3||(m.nodeType==3&&g.startOffset==0))){var l=m;while(l!=null&&l.previousSibling==null){l=l.parentNode}if(l!=null){previous_node=l.previousSibling;if(previous_node){h.selection.select(previous_node);h.selection.getSel().collapseToEnd();h.controlManager.setActive("kronos_mergefield",false)}}return true}var f=g.startContainer;if(f&&(f.nodeType!=3||(f.nodeType==3&&g.endOffset==m.nodeValue.length))){var l=f;while(l!=null&&l.nextSibling==null){l=l.parentNode}if(l!=null){next_node=l.nextSibling;if(next_node){if(WebKit){next_node.parentNode.insertBefore(document.createTextNode(" "),next_node)}h.selection.select(next_node);h.selection.getSel().collapseToStart();h.controlManager.setActive("kronos_mergefield",false)}}return true}}if(IE){k.returnValue=false;k.cancelBubble=true}else{k.preventDefault();k.stopPropagation()}return false}})},getInfo:function(){return{longname:"Integration with Kronos Web",author:"Kronostechnologies inc.",authorurl:"http://kronos-web.com",infourl:"http://kronos-web.com",version:tinymce.majorVersion+"."+tinymce.minorVersion}},createControl:function(e,b){switch(e){case"themeselect":var d=b.createListBox("themeselect",{title:"kronos.themeselect_desc",onselect:function(f){tinyMCE.activeEditor.execCommand("mceSelectTheme",false,f)}});var c=tinyMCE.activeEditor.kronos_theme_def;if(c){for(var a in c){d.add(c[a]["label"],a)}}return d}return null},_postProcess:function(a,d){var b=this,e=d.content;e=e.replace(/<style>\s*&lt;!--/,"<style>\n<!--");d.content=e.replace(/--&gt;\s*<\/style>/,"-->\n</style>")},_setContent:function(d,h){var e=this,j=h.content;this.doc_header="";this.head="";this.body_header="";this.doc_footer="";var g=j.indexOf("<body");if(g==-1){g=j.indexOf("<BODY")}if(g!=-1){end_body=j.indexOf(">",g);var b=j.indexOf("<head");if(b==-1){b=j.indexOf("<HEAD")}if(b!=-1){var a=j.indexOf("</head>");if(a==-1){a=j.indexOf("</HEAD>")}}if(b!=-1&&a!=-1){this.doc_header=j.substring(0,b);this.head=j.substring(b,a+7);this.body_header=j.substring(a+7,end_body+1)}else{this.doc_header=j.substring(0,g);this.head="<head></head>";this.body_header=j.substring(g,end_body+1)}ep=j.indexOf("</body",end_body);if(ep==-1){ep=j.indexOf("</body",ep)}h.content=j.substring(end_body+1,ep);e.doc_footer=j.substring(ep)}else{this.doc_header="<html>";this.head="<head></head>";this.body_header="<body>";this.doc_footer="</body></html>"}if(this.head!=""&&this.head!="<head></head>"){var f=this.head.match(new RegExp('<style id="kronos_theme" name="([^"]*?)"'));if(f){e.theme_name=f[1]}}},_getContent:function(a,c){var b=this;c.content=tinymce.trim(b.doc_header)+tinymce.trim(b.head)+tinymce.trim(b.body_header)+"\n"+tinymce.trim(c.content)+"\n"+tinymce.trim(b.doc_footer)},_setDefaultTheme:function(a,d){var b=this;if(!b.theme_name&&b.default_theme){b.theme_name=b.default_theme}if(!b.theme_name){b._selectTheme(0);return}var c=a.controlManager.get("themeselect");c.select(b.theme_name);b._selectTheme(b.theme_name)},_selectTheme:function(h){var j=this;var e=j.editor;var g=e.dom.doc;if(IE){for(i=0;i<g.styleSheets.length;i++){if(g.styleSheets(i).title=="kronos_theme"){var k=g.styleSheets(i);break}}if(!k){var k=g.createStyleSheet()}k.cssText=e.kronos_theme_def[h]["css_text"];k.title="kronos_theme"}else{var b=g.getElementById("kronos_theme");if(!b){var c=g.getElementsByTagName("head");var f=c[0];var b=g.createElement("style");b.setAttribute("type","text/css");b.setAttribute("id","kronos_theme");f.appendChild(b)}b.innerHTML=e.kronos_theme_def[h]["css_text"]}var d=e.kronos_theme_def[h]["bg"];if(d){g.body.background=d;g.body.style.background="url("+d+")";var a=j.body_header.indexOf("background");if(a!=-1){j.body_header=j.body_header.replace(new RegExp('background="[^"]*?"'),'background="'+d+'"')}else{j.body_header=j.body_header.replace(/>/,' background="'+d+'">')}}else{g.body.background="";g.body.style.background="";var a=j.body_header.indexOf("background");if(a!=-1){j.body_header=j.body_header.replace(new RegExp('background="[^"]*?"'),"")}}j.head='<head><style id="kronos_theme" name="'+h+'" type="text/css">'+e.kronos_theme_def[h]["css_text"]+"</style></head>"},_createMergeFieldSelect:function(){var b,a=this;b=a.editor.controlManager.createListBox("mergefieldselect",{title:"mergefield_select",cmd:"FormatBlock"});return b}});tinymce.PluginManager.add("kronos",tinymce.plugins.Kronos)})();